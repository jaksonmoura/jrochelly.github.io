<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <meta name="Description" CONTENT="Personal site of Jakson Rochelly, web developer.">
    <link rel="icon" type="image/png" href="/favicon.png"/>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,900' rel='stylesheet' type='text/css'>
    <link href="https://plus.google.com/101809280544649964042" rel="publisher" />
    <!--[if IE]><link rel="shortcut icon" href="/favicon.ico"/><![endif]-->
    <!--[if IE]> <script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/assets/css/style.css"/>
    <link rel="image_src" href="/assets/img/logo.png">
    <meta content="" property="og:site_name">
    <meta content="Jakson Rochelly" property="article:author">
    <meta content="http://jrochelly.com/img/logo.png" property="og:image">
    
    <meta content="Geralmente quando temos alguma aplicação que precisa de busca, ela contem relacionamentos entre tabelas, como por exemplo uma App de Loja, onde você tem produto relacionado com categoria, fabricante, etc. Se usarmos o Elasticsearch na aplicação, é possível que o banco de dados sofra com **queries N + 1**. Podemos acabar com isso definindo alguns índices. Imagine que temos uma aplicação de uma Livraria. Livros e autores estão inteiramente ligados por um relacionamento N -..." property="og:description">
    <meta content="article" property="og:type">
    
    
    <meta content="Elasticsearch" property="og:title">
    
    
    <meta content="2014-05-17T19:06:00-03:00" property="article:published_time">
    
    
    <title>Elasticsearch @ Jakson Rochelly</title>
    
</head>
<body>
    <header class="sidebar">
  <div class="content">
    <a href="/" id="logo"></a>
    <nav class="menu">
      <ul>
        <li><a id="link-posts" href="/#Posts">Posts</a></li>
        <li><a id="link-projects" href="/#Projects">Projects</a></li>
        <li><a id="link-contact" href="/#Contact">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>


    <div id="wrapper">
        <article class="post">
            
            <div class="post__body">
                <header>
                    
                    <h1>Elasticsearch</h1>
                    <div class="post_info">
                        <time datetime="2014-05-17T19:06:00">May 17, 2014</time>
                    </div>
                    
                </header>
                <p>Geralmente quando temos alguma aplicação que precisa de busca, ela contem relacionamentos entre tabelas, como por exemplo uma App de Loja, onde você tem produto relacionado com categoria, fabricante, etc. Se usarmos o Elasticsearch na aplicação, é possível que o banco de dados sofra com <strong>queries N + 1</strong>. Podemos acabar com isso definindo alguns índices.</p>

<p>Imagine que temos uma aplicação de uma Livraria. Livros e autores estão inteiramente ligados por um relacionamento N - M. No model <code>book.rb</code> temos:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="lineno"> 2</span>   <span class="n">has_and_belongs_to_many</span> <span class="ss">:authors</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>   <span class="kp">include</span> <span class="no">Tire</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Search</span>
<span class="lineno"> 5</span>   <span class="kp">include</span> <span class="no">Tire</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Callbacks</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>   <span class="n">mapping</span> <span class="k">do</span>
<span class="lineno"> 8</span>     <span class="n">indexes</span> <span class="ss">:id</span>
<span class="lineno"> 9</span>     <span class="n">indexes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">analyzer</span><span class="p">:</span> <span class="s1">&#39;snowball&#39;</span>
<span class="lineno">10</span>     <span class="n">indexes</span> <span class="ss">:summary</span><span class="p">,</span> <span class="ss">analyzer</span><span class="p">:</span> <span class="s1">&#39;snowball&#39;</span>
<span class="lineno">11</span>     <span class="n">indexes</span> <span class="ss">:released_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span>
<span class="lineno">12</span>     <span class="n">indexes</span> <span class="ss">:edition</span>
<span class="lineno">13</span>     <span class="n">indexes</span> <span class="ss">:isbn</span><span class="p">,</span> <span class="ss">analyzer</span><span class="p">:</span> <span class="s1">&#39;keyword&#39;</span>
<span class="lineno">14</span>   <span class="k">end</span>
<span class="lineno">15</span> 
<span class="lineno">16</span>   <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="lineno">17</span>     <span class="n">tire</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">load</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
<span class="lineno">18</span>       <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="n">params</span><span class="o">[</span><span class="ss">:query</span><span class="o">]</span> <span class="p">}</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:query</span><span class="o">].</span><span class="n">present?</span>
<span class="lineno">19</span>     <span class="k">end</span>
<span class="lineno">20</span>   <span class="k">end</span>
<span class="lineno">21</span>   
<span class="lineno">22</span> <span class="k">end</span></code></pre></div>


<p>No controller temos:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">index</span>
<span class="lineno">2</span>   <span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="lineno">3</span> <span class="k">end</span></code></pre></div>


<p>Como você pode ver acima, uma configuração normal da gem. Então na view, chamamos os autores e é aqui que mora o problema:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="no">By</span> <span class="o">&lt;%=</span> <span class="n">book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">link_to</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">author_path</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">html_safe</span> <span class="o">%&gt;</span></code></pre></div>


<p>A de chamada autores acima faz N + 1 queries, e é isso que queremos evitar:</p>

<p><figure>
<img src="/assets/img/posts/queries_n_1/rails_c_queries_n_1.png" alt="image" />
<figcaption>Rails console: Problema de queries N + 1</figcaption>
</figure></p>

<h2>Solução</h2>

<p>O que podemos fazer é adicionar um block com índices de autores, ficando assim:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="n">mapping</span> <span class="k">do</span>
<span class="lineno"> 2</span>     <span class="n">indexes</span> <span class="ss">:id</span>
<span class="lineno"> 3</span>     <span class="n">indexes</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">analyzer</span><span class="p">:</span> <span class="s1">&#39;snowball&#39;</span>
<span class="lineno"> 4</span>     <span class="n">indexes</span> <span class="ss">:summary</span><span class="p">,</span> <span class="ss">analyzer</span><span class="p">:</span> <span class="s1">&#39;snowball&#39;</span>
<span class="lineno"> 5</span>     <span class="n">indexes</span> <span class="ss">:released_at</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span>
<span class="lineno"> 6</span>     <span class="n">indexes</span> <span class="ss">:edition</span>
<span class="lineno"> 7</span>     <span class="n">indexes</span> <span class="ss">:isbn</span><span class="p">,</span> <span class="ss">analyzer</span><span class="p">:</span> <span class="s1">&#39;keyword&#39;</span>
<span class="lineno"> 8</span>     <span class="n">indexes</span> <span class="ss">:author</span> <span class="k">do</span>
<span class="lineno"> 9</span>       <span class="n">indexes</span> <span class="ss">:id</span>
<span class="lineno">10</span>       <span class="n">indexes</span> <span class="ss">:name</span>
<span class="lineno">11</span>     <span class="k">end</span>
<span class="lineno">12</span>   <span class="k">end</span></code></pre></div>


<p>Ainda no model, será necessário sobrescrever o método <code>to_indexed_json</code> para que possamos incluir autores:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno">1</span> <span class="k">def</span> <span class="nf">to_indexed_json</span>
<span class="lineno">2</span>   <span class="n">to_json</span> <span class="kp">include</span><span class="p">:</span> <span class="ss">:authors</span>
<span class="lineno">3</span> <span class="k">end</span></code></pre></div>


<p>Também, não precisamos mais fazer o elasticsearch carregar a partir do banco (puxar informações como objetos), então podemos tirar o trecho <code>(load: true)</code> do método <code>self.search</code>.</p>

<p>Reidexamos tudo com o comando <code>rake environment tire:import CLASS='Book' FORCE=true</code>. E ao recarregar a página:</p>

<p><figure>
<img src="/assets/img/posts/queries_n_1/rails_c_ok.png" alt="image" />
<figcaption>Rails console: No loadings! Yay!</figcaption>
</figure></p>

<p>Sem informações vindas do banco. Muito mais rápido! Espero que tenha ajudado. Se você conhece outra maneira, por favor, compartilhe.</p>

            </div>
        </article>

        
        <div id="disqus">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'jrochelly'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
        

        <!-- <footer id="Contact">
  <div class="footer__stuff">
    <div id="about">
      <img src="/assets/img/me.jpg" alt="Me" id="me">
      <p>Hi, my name is Jakson Rochelly, I'm a <b>passionate front-end developer</b> who likes to create stuff for people to use.</p>
    </div>
    <div id="social_links">
      <ul>
        <li><a href="http://twitter.com/jrochelly" title="Twitter"><div class="icon twitter"></div></a></li>
        <li><a href="http://github.com/jrochelly" title="Github"><div class="icon github"></div></a></li>
        <li><a href="mailto:://jrochelly@gmail.com?subject='Hey Jakson!'" title="Contact me!"><div class="icon email"></div></a></li>
        <li><a href="http://feeds.feedburner.com/jrochelly" title="Feed RSS"><div class="icon feed"></div></a></li>
      </ul>
    </div>
  </div>
</footer> -->
    </div>


    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-23777483-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <script src="/assets/js/jquery.min.js"></script>
    <!--[if lte IE 9]>
    <script src="/assets/js/masonry.min.js"></script>
    <script>
        $('.blog_posts').masonry({
          // options
          percentPosition: true,
          itemSelector: '.post_index',
          columnWidth: 250
        });
    </script>
    <![endif]-->
</body>
</html>