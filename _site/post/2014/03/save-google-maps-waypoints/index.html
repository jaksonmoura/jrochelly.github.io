<!DOCTYPE html>
<html lang='en'>
<head>
	<meta charset='utf-8' />
	<meta name="Description" CONTENT="Hi, I'm Jakson Rochelly, a web developer who loves ruby and built cool apps.">
	<link rel="icon" type="image/png" href="/favicon.png"/>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
	<link href="https://plus.google.com/101809280544649964042" rel="publisher" />
	<!--[if IE]><link rel="shortcut icon" href="/favicon.ico"/><![endif]-->
	<!--[if IE]> <script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<link rel="stylesheet" href="/css/style.css"/>
	<title>Jakson Rochelly &ndash; Saving Google Maps waypoints into database</title>
</head>
<body>
	<div id="wrapper">
		<header>
			<a href="/" id="logo"></a>
			<nav>
				<ul>
					<li><a href="/">Home</a></li>
					<li><a href="/about/">About</a></li>
				</ul>
			</nav>
			<div id="about">
				<p>Hi, I'm Jakson Rochelly, a web developer who likes to write ruby code and always tries to build good apps.</p>
				<p>Mail me on <a href="mailto:jrochelly@gmail.com">jrochelly@gmail.com</a></p>
			</div>
			<ul id="social_links">
				<li><a class="twitter" href="http://twitter.com/jrochelly" title="Twitter"></a></li>
				<li><a class="facebook" href="http://facebook.com/jrochelly" title="Facebook"></a></li>
				<li><a class="github" href="http://github.com/jrochelly" title="Github"></a></li>
				<li><a class="gplus" href="https://plus.google.com/101809280544649964042?rel=author" title="Google +"></a></li>
			</ul>
		</header>

		<section class="blog_posts">
			<article class="post">
    <div class="body">
        <header>
            <h1>Saving Google Maps waypoints into database</h1>
            <div class="post_info">
                <time datetime="2014-03-16T10:31:00">March 16, 2014</time>
            </div>
        </header>
        <p>Currently I'm building an app that shows bus routes and it's important for the project to save the waypoints, instead of just start point and end point. Thus, I'm capable to replicate the route exactly same as saved.</p>

<p>So, let's see the basic code.</p>

<div class="highlight"><pre><code class="html"><span class="lineno"> 1</span> <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 2</span>   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map-canvas&quot;</span><span class="nt">/&gt;</span>
<span class="lineno"> 3</span> <span class="nt">&lt;/div&gt;</span>
<span class="lineno"> 4</span> <span class="c">&lt;!-- footer --&gt;</span>
<span class="lineno"> 5</span> <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
<span class="lineno"> 6</span>   <span class="na">src=</span><span class="s">&quot;https://maps.googleapis.com/maps/api/js?key=AIzaSyDc7y0hbNmHzHKgaqe7VCl6a--P4VAW2lU&amp;sensor=false&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 7</span> <span class="nt">&lt;/script&gt;</span>
<span class="lineno"> 8</span> <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;maps.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="lineno"> 9</span> <span class="nt">&lt;script&gt;</span>
<span class="lineno">10</span>   <span class="nx">$</span><span class="p">(</span> <span class="nb">document</span> <span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">11</span>     <span class="nx">initialize</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="lineno">12</span>     <span class="nx">calcRoute</span><span class="p">();</span>
<span class="lineno">13</span>   <span class="p">})</span>
<span class="lineno">14</span> <span class="nt">&lt;/script&gt;</span>
</code></pre></div>


<p>The above code is used to create a new one, it allows you to edit the route and save it. To be clear I'm using google maps V3.</p>

<p>Now let's go to important thing. Don't forget to call the script as well. Obs.: I also use jQuery, so put it on the line.</p>

<p>The code I'm using takes basically two steps, <code class="code">initialize()</code> which is responsable for the definitions of the map (ie. center, maxZoomLevel, panControl, boundaries, etc.), it also receive one boolean parameter used to define whether the route can be draggleble or not. I set false for the show route page, where you can navigate the map, but cannot edit. The <code class="code">calcRoute()</code> has a simple task: take a default route to show.</p>

<p>Bellow, the map script:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno">  1</span> <span class="kd">var</span> <span class="nx">rendererEditOptions</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">  2</span>   <span class="nx">draggable</span><span class="o">:</span> <span class="kc">true</span>
<span class="lineno">  3</span> <span class="p">};</span>
<span class="lineno">  4</span> <span class="kd">var</span> <span class="nx">rendererOptions</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno">  5</span>   <span class="nx">draggable</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="lineno">  6</span>   <span class="nx">suppressMarkers</span><span class="o">:</span> <span class="kc">true</span>
<span class="lineno">  7</span> <span class="p">};</span>
<span class="lineno">  8</span> <span class="kd">var</span> <span class="nx">ren</span><span class="p">,</span>
<span class="lineno">  9</span>     <span class="nx">ser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">DirectionsService</span><span class="p">(),</span>
<span class="lineno"> 10</span>     <span class="nx">data</span> <span class="o">=</span> <span class="p">{},</span>
<span class="lineno"> 11</span>     <span class="nx">map</span><span class="p">,</span> <span class="nx">marker</span><span class="p">,</span>
<span class="lineno"> 12</span>     <span class="nx">palmas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="o">-</span><span class="mf">10.204164</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.3332</span><span class="p">),</span>
<span class="lineno"> 13</span>     <span class="nx">minZoomLevel</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="lineno"> 14</span> <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">edit</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 15</span>   <span class="kd">var</span> <span class="nx">mapOptions</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 16</span>     <span class="nx">center</span><span class="o">:</span> <span class="nx">palmas</span><span class="p">,</span>
<span class="lineno"> 17</span>     <span class="nx">zoom</span><span class="o">:</span> <span class="mi">14</span><span class="p">,</span>
<span class="lineno"> 18</span>     <span class="nx">panControl</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span>
<span class="lineno"> 19</span>     <span class="nx">streetViewControl</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span>
<span class="lineno"> 20</span>     <span class="nx">maxZoom</span><span class="o">:</span> <span class="mi">18</span><span class="p">,</span>
<span class="lineno"> 21</span>     <span class="nx">minZoom</span><span class="o">:</span> <span class="nx">minZoomLevel</span>
<span class="lineno"> 22</span>   <span class="p">};</span>
<span class="lineno"> 23</span>   <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;map-canvas&quot;</span><span class="p">),</span>
<span class="lineno"> 24</span>       <span class="nx">mapOptions</span><span class="p">);</span>
<span class="lineno"> 25</span>   <span class="c1">// Get&#39;s the boolean parameter to set the route to be draggable or not.</span>
<span class="lineno"> 26</span>   <span class="k">if</span> <span class="p">(</span><span class="nx">edit</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 27</span>     <span class="nx">ren</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">DirectionsRenderer</span><span class="p">(</span><span class="nx">rendererEditOptions</span><span class="p">);</span>
<span class="lineno"> 28</span>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 29</span>     <span class="nx">ren</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">DirectionsRenderer</span><span class="p">(</span><span class="nx">rendererOptions</span><span class="p">);</span>
<span class="lineno"> 30</span>   <span class="p">};</span>
<span class="lineno"> 31</span>   <span class="nx">ren</span><span class="p">.</span><span class="nx">setMap</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span> <span class="c1">// Make map shows up</span>
<span class="lineno"> 32</span>   <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">ren</span><span class="p">,</span> <span class="s1">&#39;directions_changed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 33</span>     <span class="nx">computeTotalDistance</span><span class="p">(</span><span class="nx">ren</span><span class="p">.</span><span class="nx">getDirections</span><span class="p">());</span>
<span class="lineno"> 34</span>   <span class="p">});</span>
<span class="lineno"> 35</span>   <span class="c1">// Limit bounds to Palmas</span>
<span class="lineno"> 36</span>   <span class="kd">var</span> <span class="nx">limitBounds</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLngBounds</span><span class="p">(</span>
<span class="lineno"> 37</span>     <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="o">-</span><span class="mf">13.2906</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.0310167</span><span class="p">),</span>
<span class="lineno"> 38</span>     <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="o">-</span><span class="mf">4.6734667</span><span class="p">,</span> <span class="o">-</span><span class="mf">45.2803667</span><span class="p">)</span>
<span class="lineno"> 39</span>   <span class="p">);</span>
<span class="lineno"> 40</span>   <span class="c1">// Listen for the dragend event</span>
<span class="lineno"> 41</span>    <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="s1">&#39;drag&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 42</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">limitBounds</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">getCenter</span><span class="p">()))</span> <span class="k">return</span><span class="p">;</span>
<span class="lineno"> 43</span>      <span class="c1">// When on the bound limit - Move the map back within the bounds</span>
<span class="lineno"> 44</span>      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getCenter</span><span class="p">(),</span>
<span class="lineno"> 45</span>          <span class="nx">x</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lng</span><span class="p">(),</span>
<span class="lineno"> 46</span>          <span class="nx">y</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lat</span><span class="p">(),</span>
<span class="lineno"> 47</span>          <span class="nx">maxX</span> <span class="o">=</span> <span class="nx">limitBounds</span><span class="p">.</span><span class="nx">getNorthEast</span><span class="p">().</span><span class="nx">lng</span><span class="p">(),</span>
<span class="lineno"> 48</span>          <span class="nx">maxY</span> <span class="o">=</span> <span class="nx">limitBounds</span><span class="p">.</span><span class="nx">getNorthEast</span><span class="p">().</span><span class="nx">lat</span><span class="p">(),</span>
<span class="lineno"> 49</span>          <span class="nx">minX</span> <span class="o">=</span> <span class="nx">limitBounds</span><span class="p">.</span><span class="nx">getSouthWest</span><span class="p">().</span><span class="nx">lng</span><span class="p">(),</span>
<span class="lineno"> 50</span>          <span class="nx">minY</span> <span class="o">=</span> <span class="nx">limitBounds</span><span class="p">.</span><span class="nx">getSouthWest</span><span class="p">().</span><span class="nx">lat</span><span class="p">();</span>
<span class="lineno"> 51</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">minX</span><span class="p">)</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">minX</span><span class="p">;</span>
<span class="lineno"> 52</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">maxX</span><span class="p">)</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">maxX</span><span class="p">;</span>
<span class="lineno"> 53</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">minY</span><span class="p">)</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">minY</span><span class="p">;</span>
<span class="lineno"> 54</span>      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">maxY</span><span class="p">)</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">maxY</span><span class="p">;</span>
<span class="lineno"> 55</span>      <span class="nx">map</span><span class="p">.</span><span class="nx">setCenter</span><span class="p">(</span><span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">));</span>
<span class="lineno"> 56</span>    <span class="p">});</span>
<span class="lineno"> 57</span>    <span class="c1">// Limit the zoom level</span>
<span class="lineno"> 58</span>   <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="s1">&#39;zoom_changed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 59</span>     <span class="k">if</span> <span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">getZoom</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">minZoomLevel</span><span class="p">)</span> <span class="nx">map</span><span class="p">.</span><span class="nx">setZoom</span><span class="p">(</span><span class="nx">minZoomLevel</span><span class="p">);</span>
<span class="lineno"> 60</span>   <span class="p">});</span>
<span class="lineno"> 61</span> <span class="p">}</span>
<span class="lineno"> 62</span> <span class="c1">// Shows a default route so we can drag and edit the way we want.</span>
<span class="lineno"> 63</span> <span class="kd">function</span> <span class="nx">calcRoute</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 64</span>   <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 65</span>       <span class="nx">origin</span><span class="o">:</span> <span class="s2">&quot;Quadra 101 Norte, Av. Teotônio Segurada, Palmas - TO&quot;</span><span class="p">,</span>
<span class="lineno"> 66</span>       <span class="nx">destination</span><span class="o">:</span> <span class="s2">&quot;Quadra 1102 Sul, Av. Teotônio Segurada, Palmas - TO&quot;</span><span class="p">,</span>
<span class="lineno"> 67</span>       <span class="nx">travelMode</span><span class="o">:</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">TravelMode</span><span class="p">.</span><span class="nx">DRIVING</span>
<span class="lineno"> 68</span>   <span class="p">};</span>
<span class="lineno"> 69</span>   <span class="nx">ser</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 70</span>     <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">DirectionsStatus</span><span class="p">.</span><span class="nx">OK</span><span class="p">)</span> <span class="p">{</span> <span class="nx">ren</span><span class="p">.</span><span class="nx">setDirections</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">}</span>
<span class="lineno"> 71</span>   <span class="p">});</span>
<span class="lineno"> 72</span> <span class="p">}</span>
<span class="lineno"> 73</span> <span class="c1">// Used for editing the saved route</span>
<span class="lineno"> 74</span> <span class="kd">function</span> <span class="nx">loadRoute</span><span class="p">(</span><span class="nx">os</span><span class="p">){</span>
<span class="lineno"> 75</span>   <span class="kd">var</span> <span class="nx">wp</span> <span class="o">=</span> <span class="p">[];</span>
<span class="lineno"> 76</span>     <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">os</span><span class="p">.</span><span class="nx">waypoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span>
<span class="lineno"> 77</span>         <span class="nx">wp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">waypoints</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">waypoints</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;stopover&#39;</span><span class="o">:</span><span class="kc">false</span> <span class="p">}</span>
<span class="lineno"> 78</span>     <span class="nx">ser</span><span class="p">.</span><span class="nx">route</span><span class="p">({</span><span class="s1">&#39;origin&#39;</span><span class="o">:</span><span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span><span class="nx">os</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">lng</span><span class="p">),</span>
<span class="lineno"> 79</span>     <span class="s1">&#39;destination&#39;</span><span class="o">:</span><span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">LatLng</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span><span class="nx">os</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">lng</span><span class="p">),</span>
<span class="lineno"> 80</span>     <span class="s1">&#39;waypoints&#39;</span><span class="o">:</span> <span class="nx">wp</span><span class="p">,</span>
<span class="lineno"> 81</span>     <span class="s1">&#39;travelMode&#39;</span><span class="o">:</span> <span class="nx">google</span><span class="p">.</span><span class="nx">maps</span><span class="p">.</span><span class="nx">DirectionsTravelMode</span><span class="p">.</span><span class="nx">DRIVING</span><span class="p">},</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">sts</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 82</span>         <span class="k">if</span><span class="p">(</span><span class="nx">sts</span><span class="o">==</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span><span class="nx">ren</span><span class="p">.</span><span class="nx">setDirections</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="lineno"> 83</span>     <span class="p">})</span>
<span class="lineno"> 84</span> <span class="p">}</span>
<span class="lineno"> 85</span> <span class="kd">function</span> <span class="nx">saveWaypoints</span><span class="p">(){</span>
<span class="lineno"> 86</span>   <span class="kd">var</span> <span class="nx">w</span><span class="o">=</span><span class="p">[],</span><span class="nx">wp</span><span class="p">;</span>
<span class="lineno"> 87</span>   <span class="kd">var</span> <span class="nx">rleg</span> <span class="o">=</span> <span class="nx">ren</span><span class="p">.</span><span class="nx">directions</span><span class="p">.</span><span class="nx">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">legs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="lineno"> 88</span>   <span class="nx">data</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat&#39;</span><span class="o">:</span> <span class="nx">rleg</span><span class="p">.</span><span class="nx">start_location</span><span class="p">.</span><span class="nx">lat</span><span class="p">(),</span> <span class="s1">&#39;lng&#39;</span><span class="o">:</span><span class="nx">rleg</span><span class="p">.</span><span class="nx">start_location</span><span class="p">.</span><span class="nx">lng</span><span class="p">()}</span>
<span class="lineno"> 89</span>   <span class="nx">data</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat&#39;</span><span class="o">:</span> <span class="nx">rleg</span><span class="p">.</span><span class="nx">end_location</span><span class="p">.</span><span class="nx">lat</span><span class="p">(),</span> <span class="s1">&#39;lng&#39;</span><span class="o">:</span><span class="nx">rleg</span><span class="p">.</span><span class="nx">end_location</span><span class="p">.</span><span class="nx">lng</span><span class="p">()}</span>
<span class="lineno"> 90</span>   <span class="kd">var</span> <span class="nx">wp</span> <span class="o">=</span> <span class="nx">rleg</span><span class="p">.</span><span class="nx">via_waypoints</span>
<span class="lineno"> 91</span>   <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">wp</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="nx">w</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">wp</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lat</span><span class="p">(),</span><span class="nx">wp</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lng</span><span class="p">()]</span>
<span class="lineno"> 92</span>   <span class="nx">data</span><span class="p">.</span><span class="nx">waypoints</span> <span class="o">=</span> <span class="nx">w</span><span class="p">;</span>
<span class="lineno"> 93</span>   <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="lineno"> 94</span>   <span class="c1">// Send data to fields</span>
<span class="lineno"> 95</span>   <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#going_start_location&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">lat</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nx">data</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">lng</span><span class="p">);</span>
<span class="lineno"> 96</span>   <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#going_waypoints&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">w</span><span class="p">));</span>
<span class="lineno"> 97</span>   <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#going_end_location&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">lat</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nx">data</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">lng</span><span class="p">);</span>
<span class="lineno"> 98</span> <span class="p">}</span>
<span class="lineno"> 99</span> <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
<span class="lineno">100</span>   <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#save_going&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">saveWaypoints</span><span class="p">()</span> <span class="p">});</span>
<span class="lineno">101</span> <span class="p">});</span>
</code></pre></div>


<p>The <code class="code">initialize()</code> is commented in the important parts and excepts the bounds the rest is kind of standard to show a map, so I will pass it and explain about the <code class="code">loadRoute(os)</code> and <code class="code">saveWaypoints()</code> functions.</p>

<h3>The Bounds</h3>

<p>The bounds is a way I find really good to limit the area where the user can navigate, He doesn't need to see China once my app is in one state only.
On line 36 I set the limit coordinates and add a drag listener to verify if the user dragged until the limit. The code is simple so I won't go into details.</p>

<h3>Saving the route</h3>

<p>When you save the way points into database using this script, it end like this: <code class="code">[[-10.1977188,-48.338372400000026],[-10.204542,-48.34220600000003],[-10.2108154,-48.3414487],[-10.2108614,-48.3248532001],[-10.2238141,-48.3255121999],[-10.2195964,-48.34521760001]]</code></p>

<p>Arrays within an array, each waypoints you create on dragging the route has coordinates, this set above is all of them chained into one line.</p>

<p>On line 87 <code class="code">rleg</code> receive <code class="code">legs[0]</code>. This <code class="code">legs[0]</code> means the route you've created. We are going to work with it. The app saves the start/end location and the waypoints as you can see on the lines 88-89 and 90-92 respectively. Lines 90-92 are responsable to make the waypoints look the same you saw in the beginning  of this session. On line 93 the <code class="code">JSON.stringfy</code> turn the data to literal string so it can be save into DB. At the end I just set the values to the fields in the form.</p>

<h3>Loading the route</h3>

<p>Loading the route is basically the inverse of saving, so you need to get the strings saved into db and put them in the function by passing the values through the parameter:</p>

<div class="highlight"><pre><code class="html"><span class="lineno">1</span> <span class="nt">&lt;script&gt;</span>
<span class="lineno">2</span>   <span class="nx">$</span><span class="p">(</span> <span class="nb">document</span> <span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">3</span>     <span class="nx">initialize</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="lineno">4</span>     <span class="nx">loadRoute</span><span class="p">(</span><span class="o">&lt;%=</span> <span class="nx">raw</span> <span class="s1">&#39;{&quot;start&quot;:{&quot;lat&quot;:&#39;</span><span class="o">+</span><span class="err">@</span><span class="nx">going</span><span class="p">.</span><span class="nx">start_location</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">to_s</span><span class="o">+</span><span class="s1">&#39;,&quot;lng&quot;:&#39;</span><span class="o">+</span><span class="err">@</span><span class="nx">going</span><span class="p">.</span><span class="nx">start_location</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">to_s</span><span class="o">+</span><span class="s1">&#39;},&quot;end&quot;:{&quot;lat&quot;:&#39;</span><span class="o">+</span><span class="err">@</span><span class="nx">going</span><span class="p">.</span><span class="nx">end_location</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">to_s</span><span class="o">+</span><span class="s1">&#39;,&quot;lng&quot;:&#39;</span><span class="o">+</span><span class="err">@</span><span class="nx">going</span><span class="p">.</span><span class="nx">end_location</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">to_s</span><span class="o">+</span><span class="s1">&#39;},&quot;waypoints&quot;:&#39;</span><span class="o">+</span><span class="err">@</span><span class="nx">going</span><span class="p">.</span><span class="nx">waypoints</span><span class="p">.</span><span class="nx">to_s</span><span class="o">+</span><span class="s1">&#39;}&#39;</span> <span class="o">%&gt;</span><span class="p">);</span>
<span class="lineno">5</span>   <span class="p">});</span>
<span class="lineno">6</span>   <span class="nt">&lt;/script&gt;</span>
</code></pre></div>


<p>As you can see I use Ruby to pass the values.</p>

<p>Well, after all this you can save/load you waypoints.</p>

    </div>
</article>

<div class="read_more">
    
    
        <div class="previous_post">
            <a href="/post/2014/01/medo-de-ser-bom">Medo de ser bom?</a>
        </div>
    
</div>


<div id="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jrochelly'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

		</section>
	</div>

	<footer>
		<p>&copy; 2014 <a href="http://twitter.com/jrochelly">Jakson Rochelly</a>.
       Built with <a href="https://github.com/mojombo/jekyll/">Jekyll</a>.
       The source of this blog is <a href="https://github.com/jrochelly/jrochelly.github.com/">on GitHub</a>.<br>
       You can <a href="http://feeds.feedburner.com/jrochelly">grab the RSS feed</a> and maybe <a href="http://twitter.com/jrochelly">follow me on Twitter</a>.</p>
	</footer>
	<script>
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-23777483-1']);
	  _gaq.push(['_trackPageview']);
	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
	</script>
</body>
</html>